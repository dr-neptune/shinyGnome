
```{r}
library(tidyverse)
library(shiny)
```

# Get a Sound 

```{r}
kick <- tuneR::readWave("kick.wav")
skick <- tuneR::readWave("psytrance.wav")

tuneR::play(kick)
tuneR::setWavPlayer("/usr/bin/paplay")

one_note <- function(bpm, sound = sobj) {
    one <- function(){
        Sys.sleep(60 / bpm)
        tuneR::play(sound)
    }
    one
}

library(tuneR)
wobj <- sine(440)
ssobj <- pulse(100, duration = 0.05, xunit = "time")
sobj <- pulse(50, duration = 0.05, xunit = "time")

tuneR::play(ssobj)

silent_note <- function(bpm) {
    one <- function() {
        Sys.sleep(60 / bpm)
        tuneR::play(tuneR::silence(duration = 0.1, xunit = "time"))
    }
    one
}

one_note(300)()
silent_note(3000)()

walk(list(one_note(120)(), silent_note(120)(), one_note(120)(), one_note(120)()), ~ .x %>% eval())

one_note(60) %>% do.call(what = ., args = "")

nth_note <- function(times, div, bpm, sound = skick) {
    note <- function() {
        speed <- floor((div / 4) * bpm)
        for (i in 1:times) {
            Sys.sleep(60 / speed)
            tuneR::play(sound)
            ## one_note(speed, sound = skick)()
        }
    }
    note
}

x_measures <- function(beat, measures = 4) {
    for (i in 1:measures) {
        beat()
    }
}

one_note(60)()
uno <- nth_note(4, 4, 60)
uno()

eval(uno())

x_measures(nth_note(4, 16, 60)(), measures = 16)

# 4 4 120 bpm 
x_measures(nth_note(4, 120), 4)

# 7 8 120 bpm
x_measures(nth_note(8, 120, 7), 4)

# what about a 16th note beat where the third note is muted? 

get_beat <- function() {
    
}



walk(list(one_note(240)(), silent_note(240)(), one_note(240)(), one_note(240)()), ~ .x %>% eval())

```

number of measures 
number of beats in a measure (time signature)
number of notes in a beat (maybe radiobars for controlling silenced beats)

# Shiny App Part 

```{r}
ui <- fluidPage(
    title = "shinyGnome",
    theme = shinythemes::shinytheme("yeti"),
    shinyjs::useShinyjs(),
    titlePanel(windowTitle = "shinyGnome",
               title = div(img(src = "https://i.ibb.co/HNtb8cX/gnome.png",
                               height = 100, width = 100,
                               style = "margin:10px 10px"),
                           "shinyGnome")),
    sidebarLayout(
        sidebarPanel(h4("Beats Per Minute"),
                     hr(),
                     sliderInput(inputId = "bpm",
                                 label = "BPM",
                                 min = 30,
                                 max = 300,
                                 value = 120,
                                 step = 1),
                     h4("Time Signature"),
                     hr(),
                     splitLayout(
                         numericInput("count",
                                      label = "Count",
                                      value = 4,
                                      min = 1,
                                      max = 150,
                                      step = 1),
                         numericInput("note_length",
                                      label = "Note Length",
                                      value = 4,
                                      min = 1,
                                      max = 150,
                                      step = 1)),
                     h4("Bars"),
                     hr(),
                     numericInput("bars",
                                  label = "Bars",
                                  value = 4,
                                  min = 1,
                                  max = 500,
                                  step = 1),
                     h4("Build It!"),
                     hr(),
                     splitLayout(shinyWidgets::actionBttn("generate",
                                              label = "Create",
                                              icon = icon("sliders"),
                                              color = "success",
                                              style = "bordered",
                                              block = TRUE),
                     shinyWidgets::actionBttn("clear",
                                              label = "Clear",
                                              icon = icon("sliders"),
                                              color = "warning",
                                              style = "bordered",
                                              block = TRUE))),
        mainPanel(h4("Beat Selecta"),
                  hr(),
                  div(id = "beatSelecta"),
                  ## uiOutput("generateBars"),
                  hr(),
                  splitLayout(shinyWidgets::radioGroupButtons("loop",
                                                  choices = c("Loop", "Noop"),
                                                  selected = "Noop",
                                                  status = "primary",
                                                  size = "sm"),
                              shinyWidgets::actionBttn("play",
                                                       label = "Play!",
                                                       style = "bordered",
                                                       color = "success",
                                                       block = TRUE,
                                                       size = "sm"),
                              shinyWidgets::actionBttn("stop",
                                                       label = "Stop!",
                                                       style = "bordered",
                                                       color = "danger",
                                                       block = TRUE,
                                                       size = "sm")))))
```

Now we want to conditionally make radio buttons for each of the beats, with one box for each note (div 4)

```{r}
server <- function(input, output, session) {
    # well, play it! 
    play_that_funky_music <- function(bpm, count, values, stop) {
            walk(1:count, ~ {
                if (.x %in% values) {
                    silent_note(bpm)()
                    cat("_")
                } else {
                    ifelse(.x == 1,
                           one_note(bpm, ssobj)(),
                           one_note(bpm)())
                    cat("*")
                }
            })
    }

    # get the rests in a given bar 
    get_pattern <- function(bar_num) {
        input[[paste0("bar_", bar_num)]] %>%
            str_extract_all(pattern = "[0-9]+") %>%
            map(as.numeric) %>%
            flatten_dbl()
    }
    
    observeEvent(input$generate, {
        walk(1:input$bars,
             ~ insertUI(selector = "#beatSelecta",
                        where = "beforeEnd",
                        ui = shinyWidgets::checkboxGroupButtons(inputId = paste0("bar_", .x),
                                                                label = paste0("Bar ", .x),
                                                                choices = 1:input$count)))
        walk(1:input$bars, ~ {
            output[[paste0("bar_txt_", .x)]] <- renderText({input[[paste0("bar_", .x)]]})
        })

        walk(1:input$bars, ~ {
            insertUI(selector = "#beatSelecta",
                     where = "beforeEnd",
                     ui = verbatimTextOutput(outputId = paste0("bar_txt_", .x)))
        })
    })
    
    observeEvent(input$clear, {
        walk(1:input$bars, ~ removeUI(selector = paste0("div:has(> #bar_", .x, ")")))
    })
    
    observeEvent(input$play, {
            map(1:input$bars, ~ get_pattern(.x)) %>% walk(., ~ {
                play_that_funky_music(bpm = input$bpm,
                                      count = input$count,
                                      values = .x,
                                      stop = input$stop)})
    })
    
}
```

```{r}
shinyApp(ui, server)
```

# Ideas

- maybe update highlight on the radio buttons with the beat 
- loop! 
- functionality for everything else (note duration)
- polyrhythms 
