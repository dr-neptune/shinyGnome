
```{r}
library(tidyverse)
library(shiny)
library(parallel)
```

# Get a Sound 

```{r}
kick <- tuneR::readWave("kick.wav")
skick <- tuneR::readWave("psytrance.wav")

tuneR::play(kick)
tuneR::setWavPlayer("/usr/bin/paplay")

one_note <- function(bpm, sound = sobj) {
    one <- function(){
        Sys.sleep((60 / bpm) - 0.05)
        tuneR::play(sound)
    }
    one
}

library(tuneR)
wobj <- sine(440)
ssobj <- pulse(100, duration = 0.05, xunit = "time")
sobj <- pulse(50, duration = 0.05, xunit = "time")

tuneR::play(ssobj)

silent_note <- function(bpm) {
    one <- function() {
        Sys.sleep((60 / bpm) - 0.05)
        tuneR::play(tuneR::silence(duration = 0.05, xunit = "time"))
    }
    one
}

one_note(300)()
silent_note(3000)()

walk(list(one_note(120)(), silent_note(120)(), one_note(120)(), one_note(120)()), ~ .x %>% eval())

one_note(60) %>% do.call(what = ., args = "")

nth_note <- function(times, div, bpm, sound = skick) {
    note <- function() {
        speed <- floor((div / 4) * bpm)
        for (i in 1:times) {
            Sys.sleep(60 / speed)
            tuneR::play(sound)
            ## one_note(speed, sound = skick)()
        }
    }
    note
}

x_measures <- function(beat, measures = 4) {
    for (i in 1:measures) {
        beat()
    }
}

one_note(60)()
uno <- nth_note(4, 4, 60)
uno()

eval(uno())

x_measures(nth_note(4, 16, 60)(), measures = 16)

# 4 4 120 bpm 
x_measures(nth_note(4, 120), 4)

# 7 8 120 bpm
x_measures(nth_note(8, 120, 7), 4)

walk(list(one_note(240)(), silent_note(240)(), one_note(240)(), one_note(240)()), ~ .x %>% eval())

```

number of measures 
number of beats in a measure (time signature)
number of notes in a beat (maybe radiobars for controlling silenced beats)

# Shiny App Part 

```{r}
ui <- fluidPage(
    title = "shinyGnome",
    theme = shinythemes::shinytheme("yeti"),
    shinyjs::useShinyjs(),
    titlePanel(windowTitle = "shinyGnome",
               title = div(img(src = "https://i.ibb.co/HNtb8cX/gnome.png",
                               height = 100, width = 100,
                               style = "margin:10px 10px"),
                           "shinyGnome")),
    sidebarLayout(
        sidebarPanel(h4("Beats Per Minute"),
                     hr(),
                     sliderInput(inputId = "bpm",
                                 label = "BPM",
                                 min = 30,
                                 max = 300,
                                 value = 120,
                                 step = 1),
                     h4("Time Signature"),
                     hr(),
                     splitLayout(
                         numericInput("count",
                                      label = "Count",
                                      value = 4,
                                      min = 1,
                                      max = 150,
                                      step = 1),
                         numericInput("note_length",
                                      label = "Note Length",
                                      value = 4,
                                      min = 1,
                                      max = 150,
                                      step = 1)),
                     h4("Bars"),
                     hr(),
                     numericInput("bars",
                                  label = "Bars",
                                  value = 4,
                                  min = 1,
                                  max = 500,
                                  step = 1),
                     h4("Build It!"),
                     hr(),
                     splitLayout(shinyWidgets::actionBttn("generate",
                                              label = "Create",
                                              icon = icon("sliders"),
                                              color = "success",
                                              style = "bordered",
                                              block = TRUE),
                     shinyWidgets::actionBttn("clear",
                                              label = "Clear",
                                              icon = icon("sliders"),
                                              color = "warning",
                                              style = "bordered",
                                              block = TRUE))),
        mainPanel(h4("Beat Selecta"),
                  hr(),
                  div(id = "preBeat"),
                  div(id = "beatSelecta"),
                  hr(),
                  splitLayout(shinyWidgets::actionBttn("play",
                                           label = "Play!",
                                           style = "bordered",
                                           color = "success",
                                           block = TRUE,
                                           size = "sm"),
                              shinyWidgets::actionBttn("stop",
                                                       label = "Stop!",
                                                       style = "bordered",
                                                       color = "danger",
                                                       block = TRUE,
                                                       size = "sm")))))
```

Now we want to conditionally make radio buttons for each of the beats, with one box for each note (div 4)

```{r}
gen_random_color <- function() {
    prng <- floor(runif(n = 1, min = 0, max = 3))
    if (prng == 0) {
        "success"
    } else if (prng == 1) {
        "warning"
    } else {
        "danger"
    }
}

server <- function(input, output, session) {
    # well, play it! 
    play_that_funky_music <- function(bpm, count, values) {
        map(1:count, ~ {
            if (.x %in% values) {
                silent_note(bpm)()
                cat("_")
            } else {
                ifelse(.x == 1,
                       one_note(bpm, ssobj)(),
                       one_note(bpm)())
                cat("*")
            }
        })
    }

    # get the rests in a given bar 
    get_pattern <- function(bar_num) {
        input[[paste0("bar_", bar_num)]] %>%
            str_extract_all(pattern = "[0-9]+") %>%
            map(as.numeric) %>%
            flatten_dbl()
    }

    # get all the inputs that follow a pattern. Used for removeUI
    getInputs <- function(pattern) {
        reactives <- names(reactiveValuesToList(input))
        reactives[grep(pattern, reactives)]
    }

    ## click_count <- 0
    # generate all the radio group buttons for the beats
    observeEvent(input$generate, {
        ## click_count <<- click_count + 1
        walk(1:input$bars,
             ~ insertUI(selector = "#beatSelecta",
                        where = "beforeEnd",
                        ui = shinyWidgets::checkboxGroupButtons(inputId = paste0("bar_", ## click_count, "_", 
                                                                                 .x),
                                                                ## label = paste0("Bar ", .x),
                                                                choices = 1:input$count,
                                                                status = gen_random_color())))
        shinyjs::disable("generate")
        shinyjs::enable("clear")
    })

    # remove those same radio group buttons
    observeEvent(input$clear, {
        removeUI(selector = "div#beatSelecta")
        insertUI(selector = "#preBeat",
                 where = "beforeEnd",
                 ui = div(id = "beatSelecta"))
        shinyjs::enable("generate")
    })

    # this is a placeholder for the child process used by the play button 
    rVal <- reactiveValues()
    rVal$process <- NULL

    # Start a child process to play the beats when play is hit
    observeEvent(input$play, {
        # if the process exists, continue 
        if (!is.null(rVal$process))
            return()

            # mcparallel doesn't seem to like being passed inputs
            bpm <- (input$bpm * (input$note_length / 4)); count <- input$count; values <- map(1:input$bars, ~ get_pattern(.x))

            # call the function 
            rVal$process <- mcparallel({
                repeat {
                    walk(values, ~ play_that_funky_music(bpm, count, .x))
                }
            })
    })

    # Stop the child process
    observeEvent(input$stop, {
        if (!is.null(rVal$process)) {
            # if its running kill it
            tools::pskill(rVal$process$pid)
            rVal$process <- NULL
        }
    })
}
```

```{r}
shinyApp(ui, server)
```

# Ideas

- maybe update highlight on the radio buttons with the beat
- loop!
- functionality for everything else (note duration)
- polyrhythms 
